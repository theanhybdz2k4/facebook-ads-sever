// Unified SaaS Ads Engine Schema
// Senior-level Multi-Platform Architecture

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["fullTextSearch"]
  binaryTargets   = ["native", "debian-openssl-1.1.x", "debian-openssl-3.0.x", "linux-arm64-openssl-3.0.x"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============================================================================
// ENUMS & TYPES
// ============================================================================

enum UnifiedStatus {
  ACTIVE
  PAUSED
  ARCHIVED
  DELETED
  UNKNOWN
}

enum SyncJobStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
}

// ============================================================================
// CORE AUTH & USERS
// ============================================================================

model User {
  id        Int       @id @default(autoincrement())
  email     String    @unique @map("email")
  password  String    @map("password")
  name      String?   @map("name")
  isActive  Boolean   @default(true) @map("is_active")
  avatarUrl String?   @map("avatar_url")
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime? @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  identities    PlatformIdentity[]
  refreshTokens RefreshToken[]
  branches      Branch[]
  cronSettings  CronSetting[]
  telegramBots  TelegramBot[]

  @@map("users")
}

model RefreshToken {
  id        Int       @id @default(autoincrement())
  userId    Int       @map("user_id")
  token     String    @unique @map("token")
  expiresAt DateTime  @map("expires_at")
  createdAt DateTime  @default(now()) @map("created_at")
  deletedAt DateTime? @map("deleted_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("refresh_tokens")
}

// ============================================================================
// PLATFORM ABSTRACTION (LAYER 1)
// ============================================================================

model Platform {
  id        Int      @id @default(autoincrement())
  code      String   @unique // 'facebook', 'tiktok', 'google'
  name      String
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")

  identities PlatformIdentity[]
  accounts   PlatformAccount[]

  @@map("platforms")
}

// ============================================================================
// UNIFIED ACCOUNT STRUCTURE (LAYER 2)
// ============================================================================

model PlatformIdentity {
  id           Int       @id @default(autoincrement())
  userId       Int       @map("user_id")
  platformId   Int       @map("platform_id")
  externalId   String    @map("external_id") // ID from Platform (e.g. FB User ID)
  name         String?   @map("name")
  isValid      Boolean   @default(true) @map("is_valid")
  errorMessage String?   @map("error_message")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")
  deletedAt    DateTime? @map("deleted_at")

  user        User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  platform    Platform             @relation(fields: [platformId], references: [id], onDelete: Cascade)
  credentials PlatformCredential[]
  accounts    PlatformAccount[]

  @@unique([platformId, externalId])
  @@index([userId])
  @@map("platform_identities")
}

model PlatformCredential {
  id              Int       @id @default(autoincrement())
  identityId      Int       @map("platform_identity_id")
  credentialType  String    @map("credential_type") // 'access_token', 'refresh_token', 'api_key'
  credentialValue String    @map("credential_value") // Encrypted
  expiresAt       DateTime? @map("expires_at")
  isActive        Boolean   @default(true) @map("is_active")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  deletedAt       DateTime? @map("deleted_at")

  identity PlatformIdentity @relation(fields: [identityId], references: [id], onDelete: Cascade)

  @@index([identityId])
  @@map("platform_credentials")
}

model PlatformAccount {
  id            Int       @id @default(autoincrement())
  identityId    Int       @map("platform_identity_id")
  platformId    Int       @map("platform_id")
  externalId    String    @map("external_id") // act_123, ...
  name          String?   @map("name")
  accountStatus String    @map("account_status") // Normalized ACTIVE, DISABLED
  currency      String?   @map("currency")
  timezone      String?   @map("timezone")
  platformData  Json?     @map("platform_data")
  branchId      Int?      @map("branch_id")
  syncedAt      DateTime? @map("synced_at")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")
  deletedAt     DateTime? @map("deleted_at")

  identity       PlatformIdentity       @relation(fields: [identityId], references: [id], onDelete: Cascade)
  platform       Platform               @relation(fields: [platformId], references: [id], onDelete: Cascade)
  branch         Branch?                @relation(fields: [branchId], references: [id], onDelete: SetNull)
  campaigns      UnifiedCampaign[]
  adGroups       UnifiedAdGroup[]
  ads            UnifiedAd[]
  insights       UnifiedInsight[]
  hourlyInsights UnifiedHourlyInsight[]
  syncJobs       SyncJob[]
  telegramBots   TelegramBot[]
  creatives      UnifiedAdCreative[]

  @@unique([platformId, externalId])
  @@index([identityId])
  @@index([branchId])
  @@map("platform_accounts")
}

// ============================================================================
// NORMALIZED ENTITY HIERARCHY (LAYER 3)
// ============================================================================

model UnifiedCampaign {
  id              String        @id @default(cuid())
  accountId       Int           @map("platform_account_id")
  externalId      String        @map("external_id")
  name            String?       @map("name")
  status          UnifiedStatus @default(ACTIVE)
  objective       String?       @map("objective")
  dailyBudget     Decimal?      @map("daily_budget") @db.Decimal(20, 4)
  lifetimeBudget  Decimal?      @map("lifetime_budget") @db.Decimal(20, 4)
  startTime       DateTime?     @map("start_time")
  endTime         DateTime?     @map("end_time")
  effectiveStatus String?       @map("effective_status")
  platformData    Json?         @map("platform_data")
  syncedAt        DateTime      @map("synced_at")
  createdAt       DateTime      @default(now()) @map("created_at")
  deletedAt       DateTime?     @map("deleted_at")

  account        PlatformAccount        @relation(fields: [accountId], references: [id], onDelete: Cascade)
  adGroups       UnifiedAdGroup[]
  insights       UnifiedInsight[]
  hourlyInsights UnifiedHourlyInsight[]

  @@unique([accountId, externalId])
  @@index([accountId])
  @@index([accountId, status])
  @@index([accountId, createdAt])
  @@map("unified_campaigns")
}

model UnifiedAdGroup {
  id               String        @id @default(cuid())
  campaignId       String        @map("unified_campaign_id")
  accountId        Int           @map("platform_account_id")
  externalId       String        @map("external_id")
  name             String?       @map("name")
  status           UnifiedStatus @default(ACTIVE)
  dailyBudget      Decimal?      @map("daily_budget") @db.Decimal(20, 4)
  optimizationGoal String?       @map("optimization_goal")
  effectiveStatus  String?       @map("effective_status")
  platformData     Json?         @map("platform_data")
  syncedAt         DateTime      @map("synced_at")
  createdAt        DateTime      @default(now()) @map("created_at")
  deletedAt        DateTime?     @map("deleted_at")

  campaign       UnifiedCampaign        @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  account        PlatformAccount        @relation(fields: [accountId], references: [id], onDelete: Cascade)
  ads            UnifiedAd[]
  insights       UnifiedInsight[]
  hourlyInsights UnifiedHourlyInsight[]

  @@unique([accountId, externalId])
  @@index([campaignId])
  @@index([accountId, status])
  @@index([accountId, createdAt])
  @@map("unified_ad_groups")
}

model UnifiedAd {
  id              String        @id @default(cuid())
  adGroupId       String        @map("unified_ad_group_id")
  accountId       Int           @map("platform_account_id")
  creativeId      String?       @map("unified_ad_creative_id")
  externalId      String        @map("external_id")
  name            String?       @map("name")
  status          UnifiedStatus @default(ACTIVE)
  effectiveStatus String?       @map("effective_status")
  platformData    Json?         @map("platform_data")
  syncedAt        DateTime      @map("synced_at")
  createdAt       DateTime      @default(now()) @map("created_at")
  deletedAt       DateTime?     @map("deleted_at")

  adGroup        UnifiedAdGroup         @relation(fields: [adGroupId], references: [id], onDelete: Cascade)
  account        PlatformAccount        @relation(fields: [accountId], references: [id], onDelete: Cascade)
  creative       UnifiedAdCreative?     @relation(fields: [creativeId], references: [id])
  insights       UnifiedInsight[]
  hourlyInsights UnifiedHourlyInsight[]

  @@unique([accountId, externalId])
  @@index([adGroupId])
  @@index([creativeId])
  @@index([accountId, status])
  @@index([accountId, effectiveStatus])
  @@index([accountId, createdAt])
  @@map("unified_ads")
}

model UnifiedAdCreative {
  id           String   @id @default(cuid())
  accountId    Int      @map("platform_account_id")
  externalId   String   @map("external_id")
  name         String?  @map("name")
  body         String?  @map("body")
  imageUrl     String?  @map("image_url")
  thumbnailUrl String?  @map("thumbnail_url")
  title        String?  @map("title")
  platformData Json?    @map("platform_data")
  syncedAt     DateTime @map("synced_at")
  createdAt    DateTime @default(now()) @map("created_at")

  account PlatformAccount @relation(fields: [accountId], references: [id], onDelete: Cascade)
  ads     UnifiedAd[]

  @@unique([accountId, externalId])
  @@map("unified_ad_creatives")
}

// ============================================================================
// UNIFIED METRICS (LAYER 4)
// ============================================================================

model UnifiedInsight {
  id         String   @id @default(cuid())
  accountId  Int      @map("platform_account_id")
  campaignId String?  @map("unified_campaign_id")
  adGroupId  String?  @map("unified_ad_group_id")
  adId       String?  @map("unified_ad_id")
  date       DateTime @map("date") @db.Date

  // Core Metrics (Normalized)
  spend       Decimal? @map("spend") @db.Decimal(20, 4)
  impressions BigInt?  @map("impressions")
  clicks      BigInt?  @map("clicks")
  reach       BigInt?  @map("reach")
  conversions BigInt?  @map("conversions")
  results     BigInt?  @map("results")

  // Optional breakdowns or platform specific metrics
  platformMetrics Json? @map("platform_metrics")

  syncedAt  DateTime  @map("synced_at")
  createdAt DateTime  @default(now()) @map("created_at")
  deletedAt DateTime? @map("deleted_at")

  account  PlatformAccount  @relation(fields: [accountId], references: [id], onDelete: Cascade)
  campaign UnifiedCampaign? @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  adGroup  UnifiedAdGroup?  @relation(fields: [adGroupId], references: [id], onDelete: Cascade)
  ad       UnifiedAd?       @relation(fields: [adId], references: [id], onDelete: Cascade)

  deviceStats    UnifiedInsightDevice[]
  ageGenderStats UnifiedInsightAgeGender[]
  regionStats    UnifiedInsightRegion[]

  @@unique([accountId, campaignId, adGroupId, adId, date])
  @@index([accountId, date])
  @@index([campaignId, date])
  @@index([adGroupId, date])
  @@index([adId, date])
  @@map("unified_insights")
}

model UnifiedInsightDevice {
  id               String  @id @default(cuid())
  unifiedInsightId String  @map("unified_insight_id")
  device           String  @map("device") // 'desktop', 'mobile', etc.
  impressionDevice String? @map("impression_device")

  spend       Decimal? @map("spend") @db.Decimal(20, 4)
  impressions BigInt?  @map("impressions")
  clicks      BigInt?  @map("clicks")
  results     BigInt?  @map("results")

  insight UnifiedInsight @relation(fields: [unifiedInsightId], references: [id], onDelete: Cascade)

  @@index([unifiedInsightId])
  @@map("unified_insight_devices")
}

model UnifiedInsightAgeGender {
  id               String @id @default(cuid())
  unifiedInsightId String @map("unified_insight_id")
  age              String @map("age")
  gender           String @map("gender")

  spend       Decimal? @map("spend") @db.Decimal(20, 4)
  impressions BigInt?  @map("impressions")
  clicks      BigInt?  @map("clicks")
  results     BigInt?  @map("results")

  insight UnifiedInsight @relation(fields: [unifiedInsightId], references: [id], onDelete: Cascade)

  @@index([unifiedInsightId])
  @@map("unified_insight_age_gender")
}

model UnifiedInsightRegion {
  id               String  @id @default(cuid())
  unifiedInsightId String  @map("unified_insight_id")
  region           String  @map("region")
  country          String? @map("country")

  spend       Decimal? @map("spend") @db.Decimal(20, 4)
  impressions BigInt?  @map("impressions")
  clicks      BigInt?  @map("clicks")
  results     BigInt?  @map("results")

  insight UnifiedInsight @relation(fields: [unifiedInsightId], references: [id], onDelete: Cascade)

  @@index([unifiedInsightId])
  @@map("unified_insight_regions")
}

model UnifiedHourlyInsight {
  id         String   @id @default(cuid())
  accountId  Int      @map("platform_account_id")
  campaignId String?  @map("unified_campaign_id")
  adGroupId  String?  @map("unified_ad_group_id")
  adId       String?  @map("unified_ad_id")
  date       DateTime @map("date") @db.Date
  hour       Int      @map("hour") // 0-23

  // Core Metrics (Normalized)
  spend       Decimal? @map("spend") @db.Decimal(20, 4)
  impressions BigInt?  @map("impressions")
  clicks      BigInt?  @map("clicks")
  results     BigInt?  @map("results")

  platformMetrics Json? @map("platform_metrics")

  syncedAt  DateTime  @map("synced_at")
  createdAt DateTime  @default(now()) @map("created_at")
  deletedAt DateTime? @map("deleted_at")

  account  PlatformAccount  @relation(fields: [accountId], references: [id], onDelete: Cascade)
  campaign UnifiedCampaign? @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  adGroup  UnifiedAdGroup?  @relation(fields: [adGroupId], references: [id], onDelete: Cascade)
  ad       UnifiedAd?       @relation(fields: [adId], references: [id], onDelete: Cascade)

  @@unique([accountId, campaignId, adGroupId, adId, date, hour])
  @@index([accountId, date, hour])
  @@map("unified_hourly_insights")
}

// ============================================================================
// SYSTEMS & TOOLS
// ============================================================================

model Branch {
  id        Int       @id @default(autoincrement())
  userId    Int       @map("user_id")
  name      String    @map("name")
  code      String?   @map("code")
  autoMatchKeywords String[]  @default([]) @map("auto_match_keywords")
  createdAt DateTime  @default(now()) @map("created_at")
  deletedAt DateTime? @map("deleted_at")

  user     User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  accounts PlatformAccount[]
  stats    BranchDailyStats[]

  @@unique([userId, name])
  @@map("branches")
}

model BranchDailyStats {
  id               Int      @id @default(autoincrement())
  branchId         Int      @map("branch_id")
  platformCode     String   @default("all") @map("platform_code")
  date             DateTime @map("date") @db.Date
  totalSpend       Decimal  @default(0) @db.Decimal(20, 4)
  totalImpressions BigInt   @default(0)
  totalClicks      BigInt   @default(0)
  totalResults     BigInt   @default(0)
  createdAt        DateTime @default(now())

  branch Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  @@unique([branchId, date, platformCode])
  @@index([branchId, date])
  @@index([branchId, platformCode])
  @@map("branch_daily_stats")
}

model SyncJob {
  id           Int           @id @default(autoincrement())
  accountId    Int           @map("platform_account_id")
  jobType      String        @map("job_type") // CAMPAIGNS, INSIGHTS...
  status       SyncJobStatus @default(PENDING)
  errorMessage String?       @map("error_message")
  startedAt    DateTime?     @map("started_at")
  completedAt  DateTime?     @map("completed_at")
  createdAt    DateTime      @default(now())
  deletedAt    DateTime?     @map("deleted_at")

  account PlatformAccount @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@map("sync_jobs")
}

model CronSetting {
  id           Int      @id @default(autoincrement())
  userId       Int      @map("user_id")
  cronType     String   @map("cron_type") // 'entities', 'insights_daily', 'insights_hour'
  allowedHours Int[]    @map("allowed_hours")
  enabled      Boolean  @default(true)
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, cronType])
  @@map("cron_settings")
}

model TelegramBot {
  id          Int       @id @default(autoincrement())
  userId      Int       @map("user_id")
  adAccountId Int?      @map("platform_account_id") // Optional link to specific account
  botToken    String    @map("bot_token")
  botName     String?   @map("bot_name")
  botUsername String?   @map("bot_username")
  isActive    Boolean   @default(true) @map("is_active")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  deletedAt   DateTime? @map("deleted_at")

  user                 User                            @relation(fields: [userId], references: [id], onDelete: Cascade)
  adAccount            PlatformAccount?                @relation(fields: [adAccountId], references: [id], onDelete: SetNull)
  notificationSettings TelegramBotNotificationSetting?
  subscribers          TelegramSubscriber[]

  @@map("telegram_bots")
}

model TelegramBotNotificationSetting {
  id           Int      @id @default(autoincrement())
  botId        Int      @unique @map("telegram_bot_id")
  allowedHours Int[]    @map("allowed_hours")
  enabled      Boolean  @default(true)
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  bot TelegramBot @relation(fields: [botId], references: [id], onDelete: Cascade)

  @@map("telegram_bot_notification_settings")
}

model TelegramSubscriber {
  id        Int      @id @default(autoincrement())
  botId     Int      @map("telegram_bot_id")
  chatId    String   @map("chat_id")
  name      String?
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")

  bot TelegramBot @relation(fields: [botId], references: [id], onDelete: Cascade)

  @@unique([botId, chatId])
  @@map("telegram_subscribers")
}
